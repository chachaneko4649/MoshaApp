<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>KAZUさんの模写アプリ_究極シンプル版</title>
    <style>
        body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; background: #333; font-family: sans-serif; }
        /* 上下半分ずつ固定 */
        #top-area, #bottom-area { height: 50vh; width: 100%; position: relative; overflow: hidden; }
        #top-area { background: #eee; display: flex; align-items: center; justify-content: center; }
        #bottom-area { background: #fff; touch-action: none; }
        
        #preview { max-width: 100%; max-height: 100%; object-fit: contain; }
        canvas { width: 100%; height: 100%; display: block; cursor: crosshair; }

        .controls-top { position: absolute; top: 10px; left: 10px; z-index: 10; }
        .toolbar { 
            position: absolute; bottom: 20px; left: 0; right: 0; 
            display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; 
            background: rgba(0,0,0,0.7); padding: 10px; color: white;
        }
        button, label { background: #555; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 13px; cursor: pointer; }
        .active { background: #007bff !important; }
        input[type="range"] { width: 80px; vertical-align: middle; }
    </style>
</head>
<body>

    <div id="top-area">
        <div class="controls-top">
            <label for="file-upload">画像を選択</label>
            <input type="file" id="file-upload" accept="image/*" style="display:none;">
        </div>
        <img id="preview" src="" alt="お手本画像">
    </div>

    <div id="bottom-area">
        <canvas id="canvas"></canvas>
        <div class="toolbar">
            <button id="btn-pen" class="active" onclick="changeMode('pen')">ペン</button>
            <button id="btn-eraser" onclick="changeMode('eraser')">消しゴム</button>
            <span>太さ:</span>
            <input type="range" id="pen-size" min="1" max="50" value="5">
            <button onclick="undo()">戻る</button>
            <button onclick="redo()">進む</button>
            <button onclick="clearCanvas()" style="background:#d9534f;">消去</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const img = document.getElementById('preview');
        const penSizeInput = document.getElementById('pen-size');
        
        let isDrawing = false;
        let mode = 'pen';
        let history = [];
        let step = -1;

        // 初期設定：画面サイズに合わせてキャンバスを作る
        function init() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            if(history.length === 0) save();
        }
        window.onload = init;
        window.onresize = init;

        function changeMode(m) {
            mode = m;
            document.getElementById('btn-pen').classList.toggle('active', m === 'pen');
            document.getElementById('btn-eraser').classList.toggle('active', m === 'eraser');
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const t = e.touches ? e.touches[0] : e;
            return { x: t.clientX - rect.left, y: t.clientY - rect.top };
        }

        function start(e) {
            if(e.cancelable) e.preventDefault();
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if(!isDrawing) return;
            const pos = getPos(e);
            ctx.lineWidth = penSizeInput.value; // スライダーの値を即時反映！
            ctx.strokeStyle = (mode === 'pen') ? '#333' : '#fff';
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function stop() {
            if(isDrawing) {
                isDrawing = false;
                save();
            }
        }

        // イベント登録（これでもかというほど確実に！）
        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', stop);

        canvas.addEventListener('touchstart', start, {passive: false});
        canvas.addEventListener('touchmove', draw, {passive: false});
        window.addEventListener('touchend', stop);

        // 履歴管理
        function save() {
            step++;
            if (step < history.length) history.length = step;
            history.push(canvas.toDataURL());
        }

        function undo() {
            if (step > 0) {
                step--;
                load();
            }
        }

        function redo() {
            if (step < history.length - 1) {
                step++;
                load();
            }
        }

        function load() {
            const temp = new Image();
            temp.src = history[step];
            temp.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(temp, 0, 0);
            };
        }

        function clearCanvas() {
            if(confirm('全部消すよ？')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                save();
            }
        }

        // 画像選択
        document.getElementById('file-upload').onchange = (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (ev) => { img.src = ev.target.result; };
                reader.readAsDataURL(file);
            }
        };
    </script>
</body>
</html>
